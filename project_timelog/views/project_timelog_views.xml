<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>
        <record id="view_task_form2" model="ir.ui.view">
            <field name="name">project.task.form</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project.view_task_form2"/>
            <field name="arch" type="xml">
                <xpath expr="//group/group[2]" position="replace">
                    <group>
                        <field name="date_deadline"/>
                        <field name="datetime_stopline" readonly="1"/>
                        <field name="categ_ids" widget="many2many_tags"/>
                        <field name="progress" widget="progressbar"
                               groups="project.group_time_work_estimation_tasks"/>
                    </group>
                </xpath>
                <xpath expr="//tree[@string='Task Work']" position="replace">
                    <tree string="Task Work" editable="top">
                        <field name="name"/>
                        <button name="play_timer" type="object" disabled="disabled"/>
                        <button name="stop_timer" type="object" disabled="disabled"/>
                        <field name="hours" widget="float_time" sum="Spent Hours"/>
                        <field name="date" readonly="1"/>
                        <field name="user_id" context="{'default_groups_ref': ['base.group_user', 'base.group_partner_manager', 'project.group_project_user']}"/>
                    </tree>
                </xpath>
            </field>
        </record>

        <record id="view_task_form3" model="ir.ui.view">
            <field name="name">project.task.form</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project_timelog.view_task_form2"/>
            <field name="groups_id" eval="[(6, 0, [ref('project.group_project_manager') ])]"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='datetime_stopline']" position="attributes">
                    <attribute name="readonly">0</attribute>
                </xpath>
            </field>
        </record>

        <!--cron-->
        <record id="ir_cron_pos_wipe_temp_order" model="ir.cron">
            <field name="name">Stop timer</field>
            <field name="active" eval="True" />
            <field name="user_id" ref="base.user_root" />
            <field name="interval_number">1</field>
            <field name="interval_type">minutes</field>
            <field name="numbercall">-1</field>
            <field name="model" eval="'im_chat.presence'" />
            <field name="function" eval="'get_chat_status'" />
            <field name="args" eval="" />
        </record>
        <!---->

        <record id="mt_timelog_stopline" model="mail.message.subtype">
            <field name="name">Stopline changed</field>
            <field name="res_model">project.task</field>
            <field name="default" eval="True"/>
            <field name="description">Stopline changed</field>
        </record>

        <record id="mt_timelog_stopline_change" model="mail.message.subtype">
            <field name="name">Stopline changed</field>
            <field name="sequence" eval="10"/>
            <field name="res_model">project.task</field>
            <field name="parent_id" eval="ref('mt_timelog_stopline')"/>
            <field name="relation_field">project_id</field>
        </record>

        <record id="view_my_timelog" model="ir.ui.view">
            <field name="name">timelog</field>
            <field name="model">project.timelog</field>
            <field name="arch" type="xml">
                <tree string="Timelog">
                    <field name="work_id" string="Subtask"/>
                    <field name="start_datetime" />
                    <field name="end_datetime" />
                    <field name="duration" string="Duration" widget="float_time"/>
                </tree>
            </field>
        </record>

        <record id="view_timelog" model="ir.ui.view">
            <field name="name">timelog</field>
            <field name="model">project.timelog</field>
            <field name="arch" type="xml">
                <tree string="Timelog">
                    <field name="user_id" string="User"/>
                    <field name="work_id" sting="Subtask"/>
                    <field name="start_datetime" />
                    <field name="end_datetime" />
                    <field name="duration" string="Duration" widget="float_time"/>
                </tree>
            </field>
        </record>

        <record id="view_timelog_graph" model="ir.ui.view">
            <field name="name">timelog.graph</field>
            <field name="model">project.timelog</field>
            <field name="arch" type="xml">
                <graph string="Timelog" type="bar">
                    <field name="duration" type="measure" widget="float_time"/>
                </graph>
            </field>
        </record>

        <record model="ir.ui.view" id="timelog_search_view">
            <field name="name">timelog.search</field>
            <field name="model">project.timelog</field>
            <field name="arch" type="xml">
                <search>
                    <field name="work_id"/>
                    <field name="duration"/>
                    <field name="user_id" string="User"/>
                    <field name="start_datetime" />
                    <field name="end_datetime" />
                    <filter name="today" string="Today" domain="[('start_datetime', '&gt;=',  ((context_today()).strftime('%%Y-%%m-%%d'))+' '+'00:00:00'), ('end_datetime', '&lt;=', ((context_today()).strftime('%%Y-%%m-%%d'))+' '+'23:59:59')]"/>
                    <separator/>
                    <filter name="week" string="This week" domain="[('start_datetime', '&gt;=', ((context_today()+relativedelta(weeks=-1, days=1, weekday=0)).strftime('%%Y-%%m-%%d'))+' '+'00:00:00'),
                                                                        ('end_datetime', '&lt;=', ((context_today()+relativedelta(weeks=0, weekday=6)).strftime('%%Y-%%m-%%d'))+' '+'23:59:59')]"/>
                    <group string="Group By">
                        <filter name="group_projects" string="Projects" domain="[]" context="{'group_by':'project_name'}"/>
                        <filter name="group_tasks" string="Tasks" domain="[]" context="{'group_by':'task_name'}"/>
                        <filter name="group_subtasks" string="Subtasks" domain="[]" context="{'group_by':'work_id'}"/>
                        <filter name="group_months" string="Months" domain="[]" context="{'group_by':'start_datetime:month'}" help="Months"/>
                        <filter name="group_weeks" string="Weeks" domain="[]" context="{'group_by':'start_datetime:week'}" help="Week"/>
                        <filter name="group_users" string="Users" context="{'group_by':'user_id'}" groups="project.group_project_manager"/>
                    </group>
                </search>
            </field>
        </record>

        <record id="action_my_timelog" model="ir.actions.act_window">
            <field name="name">My Timelog</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">project.timelog</field>
            <field name="view_type">form</field>
            <field name="view_id" ref="project_timelog.view_my_timelog"/>
            <field name="view_mode">tree,graph</field>
            <field name="domain">[('user_id', '=', uid)]</field>
            <field name="context">{
                'search_default_today': 1,
                'search_default_group_tasks': 1,
                'search_default_group_subtasks': 1,
                }
            </field>
        </record>

        <record id="action_timelog" model="ir.actions.act_window">
            <field name="name">Timelog</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">project.timelog</field>
            <field name="view_type">form</field>
            <field name="view_id" ref="project_timelog.view_timelog"/>
            <field name="view_mode">tree,graph</field>
            <field name="context">{
                'search_default_group_users': 1,
                }
            </field>
        </record>

        <menuitem id="menu_timelog_content" parent="base.menu_main_pm"
                  name="Timelog"/>

        <menuitem sequence="0"
                  id="menu_new_my_timelog_content"
                  parent="menu_timelog_content"
                  action="action_my_timelog"/>

        <menuitem sequence="1"
                  id="menu_new_timelog_content"
                  parent="menu_timelog_content"
                  groups="project.group_project_manager"
                  action="action_timelog"/>
    </data>
</openerp>